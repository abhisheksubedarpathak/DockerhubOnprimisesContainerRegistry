// Copyright Project Harbor Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//    http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package registry

import (
	"github.com/goharbor/harbor/src/core/api"
	"github.com/goharbor/harbor/src/core/config"
	"net/http"
	"net/url"
)

// TODO remove this file

// TODO seems xsrf isn't enabled for http.Handler if bind the handler to beego
// router directly

// TODO swagger handler needs to be wrapped with beego handler either
// TODO make sure the context value is visible inside the handlers generated by swagger

var registry http.Handler

// Init the registry handler
func Init() error {
	regURL, err := config.RegistryURL()
	if err != nil {
		return err
	}
	url, err := url.Parse(regURL)
	if err != nil {
		return err
	}
	registry = New(url)
	return nil
}

// BeegoController wraps the registry handler
// If bind the http.Handler to the beego router directly, the context values
// populated by filter isn't visible inside the handler
// More detail: https://github.com/astaxie/beego/issues/3906
type BeegoController struct {
	api.BaseController
}

// Prepare handle xsrf
func (b *BeegoController) Prepare() {
	// handle XSRF
	b.BaseController.Prepare()
}

// Run handles the request by calling handler's ServeHTTP
func (b *BeegoController) Run() {
	registry.ServeHTTP(b.Ctx.ResponseWriter, b.Ctx.Request)
}
