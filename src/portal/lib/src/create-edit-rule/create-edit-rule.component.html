<clr-modal [(clrModalOpen)]="createEditRuleOpened" [clrModalStaticBackdrop]="true" [clrModalClosable]="false">
  <h3 class="modal-title">{{headerTitle | translate}}</h3>
  <hbr-inline-alert class="modal-title" (confirmEvt)="confirmCancel($event)"></hbr-inline-alert>
  <div class="modal-body modal-body-height">
    <form [formGroup]="ruleForm" novalidate>
      <section class="form-block">
        <div class="form-group form-group-override">
          <label class="form-group-label-override required">{{'REPLICATION.NAME' | translate}}</label>
          <label aria-haspopup="true" role="tooltip" class="tooltip tooltip-validation tooltip-md tooltip-bottom-left" [class.invalid]='(ruleForm.controls.name.touched && ruleForm.controls.name.invalid) || !isRuleNameValid'>
            <input type="text" id="ruleName" pattern="^[a-z0-9]+(?:[._-][a-z0-9]+)*$" class="inputWidth" required maxlength="255" formControlName="name"
              #ruleName (keyup)='checkRuleName()' autocomplete="off">
            <span class="tooltip-content">{{ruleNameTooltip | translate}}</span>
          </label>
          <span class="spinner spinner-inline spinner-pos" [hidden]="!inNameChecking"></span>
        </div>
        <!--Description-->
        <div class="form-group form-group-override">
          <label class="form-group-label-override">{{'REPLICATION.DESCRIPTION' | translate}}</label>
          <textarea type="text" id="ruleDescription" class="inputWidth" row=3 formControlName="description"></textarea>
        </div>
        <!-- replication mode -->
        <div class="form-group form-group-override">
          <label class="form-group-label-override">{{'REPLICATION.REPLI_MODE' | translate}}</label>
          <div class="radio" style="display:inherit;">
            <input type="radio" id="push_base" name="replicationMode" [value]=true [(ngModel)]="isPushMode" (change)="pushModeChange()" [ngModelOptions]="{standalone: true}">
            <label for="push_base">Push-based</label>
            <input type="radio" id="pull_base" name="replicationMode" [value]=false [(ngModel)]="isPushMode" (change)="pullModeChange()" [ngModelOptions]="{standalone: true}">
            <label for="pull_base">Pull-based</label>
          </div>
        </div>
        <!--source registry-->
        <div *ngIf="!isPushMode" class="form-group form-group-override">
          <label class="form-group-label-override  required">{{'REPLICATION.SOURCE_REGISTRY' | translate}}</label>
          <div class="form-select">
            <div class="select endpointSelect pull-left">
              <select id="src_registry_id" (change)="sourceChange($event)" formControlName="src_registry" [compareWith]="equals">
                <option *ngFor="let source of sourceList; let i=index" [ngValue]="source">{{source.name}}-{{source.url}}</option>
              </select>
            </div>
          </div>
          <label *ngIf="noEndpointInfo.length != 0" class="colorRed alertLabel">{{noEndpointInfo | translate}}</label>
          <span class="alertLabel goLink" *ngIf="noEndpointInfo.length != 0" (click)="goRegistry()">{{'REPLICATION.ENDPOINTS' | translate}}</span>
        </div>
        <!--source namespace -->
        <div class="form-group form-group-override" *ngIf="isPushMode? true:ruleForm.controls.src_registry.value?.id">
          <label class="form-group-label-override  required">{{'REPLICATION.SOURCE_NAMESPACES' | translate}}</label>
          <div formArrayName="src_namespaces">
            <div class="width-315" *ngFor="let src_namespace of src_namespaces.controls; let i=index">
              <div class="endpointSelect pull-left" >
                <label aria-haspopup="true" role="tooltip" class="tooltip tooltip-validation tooltip-md tooltip-top-left" [class.invalid]='selectSrcNamespacesNoSrcInfo'>
                  <input type="text" (keyup)='handleValidation(i, "src_namespaces",isPushMode?0:ruleForm.controls.src_registry.value.id, "selectSrcNamespaces");src_namespace_index =i' [formControlName]="i" class="inputWidth" required maxlength="255">
                  <span class="tooltip-content">{{ selectSrcNamespacesNoSrcInfo | translate}}</span>
                </label>
              </div>
              <clr-icon shape="times-circle" class="is-solid" (click)="deleteNamespace(i)"></clr-icon>
            </div>
          </div>
          <clr-icon id="addSourceNamespace" shape="plus-circle" class="is-solid mr-t-10" (click)="addNewNamespace()"></clr-icon>
          <div class="selectBox" [style.display]="selectSrcNamespaces.length ? 'block' : 'none'">
            <ul (mouseleave)="leaveInput()">
                <li *ngFor="let sname of selectSrcNamespaces" (click)="selectedSrcName(sname?.name, src_namespace_index, 'src_namespaces',selectSrcNamespaces);leaveInput()">{{sname?.name}}</li>
            </ul>
          </div>
        </div>
        <!--images/Filter-->
        <div class="form-group form-group-override">
          <label class="form-group-label-override">{{'REPLICATION.SOURCE_RESOURCE_FILTER' | translate}}</label>
          <div formArrayName="filters">
            <div class="filterSelect" *ngFor="let filter of filters.controls; let i=index">
              <div [formGroupName]="i">
                <div class="width-70">
                  <label>{{"REPLICATION." + supportedFilters[i]?.type.toUpperCase() | translate}}:</label>
                </div>
                <label *ngIf="supportedFilters[i]?.style==='input'" aria-haspopup="true" role="tooltip" class="tooltip tooltip-validation tooltip-md tooltip-bottom-left"
                  [class.invalid]='(filter.value.dirty || filter.value.touched) && filter.value.invalid'>
                  <input type="text" #filterValue required size="14" formControlName="value">
                  <span class="tooltip-content">{{'TOOLTIP.EMPTY' | translate}}</span>
                </label>
                <div class="select inline-block" *ngIf="supportedFilters[i]?.style==='radio'">
                  <select  formControlName="value" #selectedValue id="{{i}}" name="{{supportedFilters[i]?.type}}">
                    <option *ngFor="let value of supportedFilters[i]?.values;" value="{{value}}">{{value}}</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--destination registry-->
        <div *ngIf="isPushMode" class="form-group form-group-override">
          <label class="form-group-label-override  required">{{'REPLICATION.DEST_REGISTRY' | translate}}</label>
          <div class="form-select">
            <div class="select endpointSelect pull-left">
              <select id="dest_registry" (change)="targetChange($event)" formControlName="dest_registry"  [compareWith]="equals">
                <option *ngFor="let target of targetList" [ngValue]="target">{{target.name}}-{{target.url}}</option>
              </select>
            </div>
          </div>
          <label *ngIf="noEndpointInfo.length != 0" class="colorRed alertLabel">{{noEndpointInfo | translate}}</label>
          <span class="alertLabel goLink" *ngIf="noEndpointInfo.length != 0" (click)="goRegistry()">{{'REPLICATION.ENDPOINTS' | translate}}</span>
        </div>
        <!--destination namespaces -->
        <div class="form-group form-group-override" *ngIf="isPushMode? ruleForm.controls.dest_registry.value?.id: true">
          <label class="form-group-label-override">{{'REPLICATION.DEST_NAMESPACE' | translate}}</label>
          <div class="form-select" formArrayName="dest_namespace">
            <div class="endpointSelect pull-left" *ngFor="let dest_name of dest_namespace.controls; let i=index">
              <label aria-haspopup="true" role="tooltip" class="tooltip tooltip-validation tooltip-md tooltip-top-left" [class.invalid]='selectDestNamespacesNoSrcInfo'>
                <input [formControlName]="i" (keyup)='handleValidation(0, "dest_namespace",isPushMode?ruleForm.controls.dest_registry.value.id:0, "selectDestNamespaces");' type="text" id="dest_namespace--{{i}}" pattern="^[a-z0-9]+(?:[._-][a-z0-9]+)*$" class="inputWidth"
                maxlength="255">
                <span class="tooltip-content">{{ selectDestNamespacesNoSrcInfo | translate}}</span>
              </label>
            </div>
          </div>
          <div class="selectBox" [style.display]="selectDestNamespaces.length ? 'block' : 'none'">
            <ul (mouseleave)="leaveInput()">
                <li *ngFor="let sname of selectDestNamespaces" (click)="selectedSrcName(sname?.name, 0, 'dest_namespace',selectDestNamespaces);leaveInput()">{{sname?.name}}</li>
            </ul>
          </div>
        </div>

        <!--Trigger-->
        <div class="form-group form-group-override">
          <label class="form-group-label-override">{{'REPLICATION.TRIGGER_MODE' | translate}}</label>
          <div formGroupName="trigger">
            <!--on trigger-->
            <div class="select width-115">
              <select id="ruleTrigger" formControlName="type" (change)="selectTrigger($event)">
                <option *ngFor="let trigger of supportedTriggers" [value]="trigger">{{'REPLICATION.' + trigger.toUpperCase() | translate }}</option>
              </select>
            </div>
            <!--on push-->
            <div formGroupName="trigger_settings">
              <div [hidden]="isNotSchedule()">
                <label>Cron String</label>
                <label for="targetCron" aria-haspopup="true" role="tooltip" class="tooltip tooltip-validation tooltip-md tooltip-top-right">
                  <input type="text" name=targetCron id="targetCron" required class="form-control cron-input" formControlName="cron">
                  <span class="tooltip-content">
                    {{'TOOLTIP.CRON_REQUIRED' | translate }}
                  </span>
                </label>
              </div>
            </div>
          </div>
          <div [hidden]="isNotEventBased()" class="clr-form-control rule-width">
            <clr-checkbox-wrapper>
              <input type="checkbox" clrCheckbox [checked]="false" id="ruleDeletion" formControlName="deletion" class="clr-checkbox">
              <label for="ruleDeletion" class="clr-control-label">{{'REPLICATION.DELETE_REMOTE_IMAGES' | translate}}</label>
            </clr-checkbox-wrapper>
          </div>
          <div class="clr-form-control rule-width">
              <clr-checkbox-wrapper>
                <input type="checkbox" clrCheckbox [checked]="true" id="enablePolicy" formControlName="enabled" class="clr-checkbox">
                <label for="enablePolicy" class="clr-control-label">{{'REPLICATION.ENABLED' | translate}}</label>
              </clr-checkbox-wrapper>
            </div>
        </div>
        <div class="loading-center">
          <span class="spinner spinner-inline" [hidden]="inProgress === false"></span>
        </div>
      </section>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" id="ruleBtnCancel" class="btn btn-outline" [disabled]="this.inProgress" (click)="onCancel()">{{ 'BUTTON.CANCEL' | translate }}</button>
    <button type="submit" id="ruleBtnOk" class="btn btn-primary" (click)="onSubmit()" [disabled]="!isValid || !hasFormChange()">{{ 'BUTTON.SAVE' | translate }}</button>
  </div>
</clr-modal>