workspace:
  base: /drone
  path: src/github.com/vmware/harbor

pipeline:
  clone:
    image: plugins/git
    tags: true
    recursive: false

  test-and-issue-build:
    image: vmware/harbor-e2e-engine:1.39
    pull: true
    privileged: true
    environment:
      BIN: bin
      GOPATH: /drone
      SHELL: /bin/bash
      LOG_TEMP_DIR: install-logs
    dns: 10.117.0.1
    secrets:
      - drone_server
      - drone_token
      - drone_token_inte
      - github_automation_api_key
      - gs_client_email
      - gs_private_key
      - gs_project_id
      - harbor_admin
      - harbor_password
      - mail_pwd
      - npm_password
      - npm_username
    commands:
      - export DOMAIN=${CI_DOMAIN}
      - tests/integration.sh
    when:
      status: success

  notify-slack:
    image: plugins/slack
    secrets:
      - source: slack_url
        target: slack_webhook
    username: drone
    template: >
      build https://ci-vic.vmware.com/vmware/harbor/{{ build.number }} finished with a {{ build.status }} status. Please find logs at https://storage.googleapis.com/harbor-ci-logs/integration_logs_{{ build.number }}_{{ build.commit }}.tar.gz
    when:
      repo: vmware/harbor
      branch: [ master, release-*, refs/tags/* ]
      status: [ failure, success ]

  trigger:
    image: plugins/downstream
    server: https://ci-vic.vmware.com
    secrets:
      - downstream_token
    fork: true
    repositories:
       - vmware/vic-product
    when:
      repo: vmware/harbor
      event: [ push, tag ]
      branch: [ master, release-*, refs/tags/* ]
      status: success
